<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Robot Words ‚Äî Lite (3 Levels, Fixed Repeated Letters)</title>
<style>
  :root{
    --bg:#0e1324;
    --panel:#141b35;
    --accent:#4cc9f0;
    --accent-2:#ffd166;
    --good:#2dd4bf;
    --bad:#ff6b6b;
    --text:#eef4ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    background: var(--bg);
  }

  .wrap{min-height:100%; max-width:1000px; margin:0 auto; padding:12px; display:grid; gap:12px; grid-template-rows:auto auto 1fr auto}
  header{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .brand{display:flex; align-items:center; gap:10px}
  .brand h1{font-size:20px; margin:0}
  .pill{padding:6px 10px; border-radius:999px; background:#1a2245; border:1px solid #2a3772; font-size:12px}

  .controls{background:#12193a; border:1px solid #22306c; border-radius:14px; padding:12px; display:grid; gap:10px}
  .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  textarea, input, select, button{font:inherit; color:var(--text)}
  textarea, input, select{width:100%; background:#0f1634; border:1px solid #2a3772; border-radius:10px; padding:10px}
  textarea{height:120px; resize:vertical}
  label{font-size:14px; opacity:.9}

  .btn{
    background:#1a2a6a; border:1px solid #3451b2; border-radius:12px; padding:12px 14px;
    cursor:pointer; user-select:none; transition:filter .15s ease, transform .05s ease;
    font-weight:700; text-align:center; min-width:120px;
  }
  .btn:hover{filter:brightness(1.08)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:#2563eb; border-color:#3b82f6}
  .btn.good{background:#16a34a; border-color:#22c55e}
  .btn.warn{background:#f59e0b; border-color:#fbbf24}
  .btn.ghost{background:#0f1634; border-style:dashed}

  .hud{display:flex; gap:8px; align-items:center; justify-content:space-between; background:#111736; border:1px solid #22306c; border-radius:12px; padding:8px 10px}
  .progress{flex:1; height:10px; background:#0b1130; border:1px solid #22306c; border-radius:999px; overflow:hidden}
  .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent-2), var(--accent)); transition:width .3s ease}

  .panel{background:#111736; border:1px solid #22306c; border-radius:14px; padding:14px; min-height:360px; display:grid; place-items:center; text-align:center}
  .stage-title{margin:0 0 6px; font-size:20px}
  .big-word{font-size:38px; font-weight:900; letter-spacing:.04em; margin:6px 0 10px}

  .slots{display:flex; gap:6px; justify-content:center; margin:8px 0 12px}
  .slot{width:38px; height:44px; border:2px dashed #2a3772; border-radius:10px; display:grid; place-items:center; font-weight:800}
  .bubbles{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
  .bubble{display:grid; place-items:center; width:56px; height:56px; border-radius:999px; background: radial-gradient(circle at 30% 25%, #5cc8ff, #2a7fff); color:#fff; font-weight:900; border:2px solid rgba(255,255,255,.25); cursor:pointer; box-shadow: 0 8px 16px rgba(0,0,0,.35); user-select:none}

  .letters{display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
  .tile{padding:10px 12px; border-radius:10px; background:#1a2a6a; border:1px solid #3451b2; cursor:grab; user-select:none; font-weight:900; min-width:38px}
  .tile:active{cursor:grabbing}
  .dropzone{display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:10px}
  .dz{min-width:38px; min-height:44px; border:2px dashed #2a3772; border-radius:10px; display:grid; place-items:center; font-weight:900}
  .dz.filled{border-color:var(--good); background:rgba(45,212,191,.15)}

  .input{font-size:18px; text-align:center}
  .footer{display:flex; gap:10px; justify-content:space-between; align-items:center}

  #confetti{position:fixed; inset:0; pointer-events:none; z-index:0}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="wrap">
<header>
<div class="brand">
<span style="font-size:22px">ü§ñ</span>
<h1>Robot Words ‚Äî Lite</h1>
</div>
<div class="row" style="justify-content:flex-end">
<button class="btn ghost" id="howTo" type="button">How to play</button>
<button class="btn warn" id="reset" type="button">Reset</button>
<button class="btn primary" id="start" type="button">Start</button>
</div>
</header>
<section aria-label="Settings" class="controls">
<div class="row">
<label for="wordBox" style="flex:1 1 160px">Your Words (one per line)</label>
</div>
<textarea id="wordBox" spellcheck="false">accusation
admiration
adoration
aspiration
civilization
colonization
combination
condensation
configuration
conjuration
conversation
declaration
determination
dispensation
dramatization
examination
exploration
imagination
improvisation
inclination</textarea>
<div class="row">
<div style="flex:1 1 160px">
<label for="orderMode">Order</label>
<select id="orderMode">
<option value="as-is">Keep order</option>
<option value="shuffle">Shuffle</option>
<option value="short-to-long">Short ‚Üí Long</option>
<option value="long-to-short">Long ‚Üí Short</option>
</select>
</div>
<div style="flex:1 1 160px">
<label for="difficulty">Difficulty</label>
<select id="difficulty">
<option value="easy">Easy</option>
<option selected="" value="normal">Normal</option>
<option value="hard">Hard</option>
</select>
</div>
<div style="flex:1 1 160px">
<label for="timeLimit">Level 3 time (s)</label>
<input id="timeLimit" max="60" min="3" type="number" value="12"/>
</div>
<div style="flex:0 0 auto; align-self:end">
<button class="btn good" id="apply" type="button">Apply</button>
</div>
</div>
</section>
<section class="hud">
<span class="pill">Stage: <strong id="stageName">‚Äî</strong></span>
<span class="pill">Word <strong id="wordIndex">0</strong>/<strong id="wordTotal">0</strong></span>
<div aria-label="Progress" class="progress"><div class="bar" id="bar"></div></div>
<span class="pill">‚≠ê <strong id="stars">0</strong></span>
</section>
<main class="panel" id="panel">
<div class="screen" id="screenHome">
<h2 class="stage-title">Welcome!</h2>
<p>Paste your words, press <b>Start</b>, and clear three friendly levels:</p>
<p>1) Tap letters ‚Ä¢ 2) Drag &amp; drop ‚Ä¢ 3) Type before the timer.</p>
</div>
<div class="screen" hidden="" id="screenS1">
<h3 class="stage-title">Stage 1 ‚Äî Tap the Bubbles</h3>
<div class="big-word" id="s1Target">word</div>
<div class="slots" id="s1Slots"></div>
<div aria-live="polite" class="bubbles" id="s1Bubbles"></div>
</div>
<div class="screen" hidden="" id="screenS2">
<h3 class="stage-title">Stage 2 ‚Äî Drag &amp; Drop</h3>
<div class="big-word" id="s2Target">word</div>
<div class="letters" id="s2Letters"></div>
<div class="dropzone" id="s2Drop"></div>
</div>
<div class="screen" hidden="" id="screenS3">
<h3 class="stage-title">Stage 3 ‚Äî Boss Typing</h3>
<div class="big-word" id="s3Target">word</div>
<input autocomplete="off" class="input" id="s3Input" placeholder="Type the word here" spellcheck="false" type="text"/>
<div class="pill">‚è±Ô∏è Time left: <span id="timer">0</span>s</div>
</div>
<div class="screen" hidden="" id="screenWin">
<h2 class="stage-title">Great job! üéâ</h2>
<p>All stages cleared. Play again or try a new list.</p>
<button class="btn primary" id="again" type="button">Play again</button>
</div>
</main>
<footer class="footer">
<div class="row">
<button class="btn ghost" id="prev" type="button">‚üµ Prev</button>
<button class="btn ghost" id="next" type="button">Next ‚ü∂</button>
</div>
<div class="row">
<button class="btn ghost" id="exportBtn" type="button">Export progress</button>
<button class="btn ghost" id="importBtn" type="button">Import progress</button>
<input accept=".json" hidden="" id="filePicker" type="file"/>
</div>
</footer>
</div>
<script>
// Helpers
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const shuffle=(a)=>{for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]];} return a;};

// State
const state = {
  stage:0, words:[], idx:0, stars:0,
  difficulty:'normal', limit:12, order:'as-is',
  progress(){ return this.words.length ? this.idx/this.words.length : 0; }
};

// Confetti
const confetti = document.getElementById('confetti');
const cctx = confetti.getContext('2d');
let confettiPieces=[];
function burst(){
  confetti.width = innerWidth; confetti.height = innerHeight;
  const colors = ['#4cc9f0','#ffd166','#2dd4bf','#a78bfa','#ff6b6b'];
  confettiPieces = Array.from({length:120},()=>({x:Math.random()*innerWidth,y:-20,r:3+Math.random()*3,c:colors[(Math.random()*colors.length)|0],s:2+Math.random()*2,a:Math.random()*6}));
  requestAnimationFrame(drawConfetti);
}
function drawConfetti(){
  cctx.clearRect(0,0,confetti.width,confetti.height);
  confettiPieces.forEach(p=>{p.y+=p.s; p.x+=Math.sin(p.a+=0.04); cctx.fillStyle=p.c; cctx.beginPath(); cctx.arc(p.x,p.y,p.r,0,Math.PI*2); cctx.fill();});
  confettiPieces = confettiPieces.filter(p=>p.y<innerHeight+20);
  if(confettiPieces.length) requestAnimationFrame(drawConfetti);
}
addEventListener('resize', ()=>{confetti.width=innerWidth; confetti.height=innerHeight;});

// HUD
function updateHud(){
  $('#stageName').textContent = state.stage===0?'‚Äî':`Stage ${state.stage}`;
  $('#wordTotal').textContent = state.words.length;
  $('#wordIndex').textContent = clamp(state.idx+1,0,state.words.length);
  $('#stars').textContent = state.stars;
  $('#bar').style.width = (state.progress()*100).toFixed(0)+'%';
}

// Screens
const screens = { home: $('#screenHome'), s1: $('#screenS1'), s2: $('#screenS2'), s3: $('#screenS3'), win: $('#screenWin') };
function show(name){ Object.values(screens).forEach(el => el.hidden = true); screens[name].hidden = false; }

// Words
function parseWords(t){ return t.split(/[\n,]+/).map(w=>w.trim()).filter(Boolean); }
function orderWords(list, mode){
  const arr=[...list];
  if(mode==='shuffle') return shuffle(arr);
  if(mode==='short-to-long') return arr.sort((a,b)=>a.length-b.length);
  if(mode==='long-to-short') return arr.sort((a,b)=>b.length-a.length);
  return arr;
}

// NEW: multiset bubble pool so repeated letters work (e.g., banana, apple)
function letterPool(word){
  // Start with each actual letter once per occurrence
  const base = word.toLowerCase().split('');
  // Add distractors based on difficulty
  const extras = state.difficulty==='easy'?1: state.difficulty==='normal'?3:5;
  const alphabet='abcdefghijklmnopqrstuvwxyz';
  for(let i=0;i<extras;i++){
    base.push(alphabet[(Math.random()*alphabet.length)|0]);
  }
  return shuffle(base);
}

// Stage 1
function stage1(){
  show('s1'); state.stage=1; updateHud();
  const w = state.words[state.idx]; $('#s1Target').textContent = w;
  const slots = $('#s1Slots'); slots.innerHTML='';
  const progress = Array(w.length).fill('');
  w.split('').forEach(()=>{ const s=document.createElement('div'); s.className='slot'; slots.appendChild(s); });
  const pool = $('#s1Bubbles'); pool.innerHTML='';

  letterPool(w).forEach((ch, i)=>{
    const b=document.createElement('button'); b.className='bubble'; b.type='button'; b.textContent=ch.toUpperCase();
    b.addEventListener('click', ()=>{
      const pos = progress.findIndex(x=>!x);
      if (w[pos]?.toUpperCase() === ch.toUpperCase()){
        progress[pos]=ch.toUpperCase(); slots.children[pos].textContent=ch.toUpperCase();
        b.disabled=true; b.style.opacity='.5';
        if(progress.join('')===w.toUpperCase()){ state.stars++; updateHud(); setTimeout(()=>stage2(), 400); }
      }
    });
    pool.appendChild(b);
  });
}

// Stage 2
let s2Filled=0;
function stage2(){
  show('s2'); state.stage=2; updateHud();
  const w = state.words[state.idx]; $('#s2Target').textContent = w;
  const letters=$('#s2Letters'); letters.innerHTML='';
  const drop=$('#s2Drop'); drop.innerHTML=''; s2Filled=0;

  shuffle(w.split('')).forEach((ch,i)=>{
    const t=document.createElement('div'); t.className='tile'; t.textContent=ch.toUpperCase(); t.draggable=true; t.id=`t-${i}-${ch}`;
    t.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', t.id));
    
    // Touch support
    t.addEventListener('touchstart', e => {
      t.classList.add('dragging');
      e.preventDefault();
    });
    t.addEventListener('touchmove', e => {
      const touch = e.touches[0];
      t.style.position = 'fixed';
      t.style.left = (touch.clientX - t.offsetWidth / 2) + 'px';
      t.style.top = (touch.clientY - t.offsetHeight / 2) + 'px';
      t.style.zIndex = 1000;
    });
    t.addEventListener('touchend', e => {
      t.classList.remove('dragging');
      t.style.position = '';
      t.style.left = '';
      t.style.top = '';
      t.style.zIndex = '';
      const touch = e.changedTouches[0];
      const target = document.elementFromPoint(touch.clientX, touch.clientY);
      if (target && target.classList.contains('dz') && !target.classList.contains('filled')) {
        if (target.dataset.char === t.textContent) {
          target.textContent = t.textContent;
          target.classList.add('filled');
          t.remove();
          s2Filled++;
          if (s2Filled === w.length) {
            state.stars++;
            updateHud();
            setTimeout(() => stage3(), 400);
          }
        }
      }
    });
letters.appendChild(t);
  });
  w.split('').forEach((ch)=>{
    const dz=document.createElement('div'); dz.className='dz'; dz.dataset.char=ch.toUpperCase();
    dz.addEventListener('dragover', e=>e.preventDefault());
    dz.addEventListener('drop', e=>{
      e.preventDefault();
      const id=e.dataTransfer.getData('text/plain'); const el=document.getElementById(id); if(!el) return;
      if(el.textContent===dz.dataset.char && !dz.classList.contains('filled')){
        dz.textContent=el.textContent; dz.classList.add('filled'); el.remove(); s2Filled++;
        if(s2Filled===w.length){ state.stars++; updateHud(); setTimeout(()=>stage3(), 400); }
      }
    });
    drop.appendChild(dz);
  });
}

// Stage 3
let timerId=null, timeLeft=0;
function stage3(){
  show('s3'); state.stage=3; updateHud();
  const w = state.words[state.idx]; $('#s3Target').textContent = w;
  const input=$('#s3Input'); input.value=''; input.focus();
  timeLeft = clamp(state.limit,3,60); $('#timer').textContent = timeLeft;
  if(timerId) clearInterval(timerId);
  timerId=setInterval(()=>{
    timeLeft--; $('#timer').textContent=timeLeft;
    if(timeLeft<=0){ clearInterval(timerId); state.stage=1; show('s1'); stage1(); }
  },1000);
  input.oninput=()=>{
    if(input.value.trim().toLowerCase()===w.toLowerCase()){
      clearInterval(timerId); state.stars++; updateHud();
      if(state.idx===state.words.length-1){ show('win'); state.stage=4; updateHud(); burst(); }
      else{ state.idx++; stage1(); }
    }
  }
}

// Navigation
$('#prev').addEventListener('click', ()=>{
  if(state.idx>0){ state.idx--; if(state.stage===2) stage2(); else if(state.stage===3) stage3(); else stage1(); }
});
$('#next').addEventListener('click', ()=>{
  if(state.idx<state.words.length-1){ state.idx++; if(state.stage===2) stage2(); else if(state.stage===3) stage3(); else stage1(); }
  else if(state.stage===3){ show('win'); state.stage=4; updateHud(); burst(); }
});

// Settings
function applySettings(){
  state.limit = parseInt($('#timeLimit').value||'12',10);
  state.difficulty = $('#difficulty').value;
  state.order = $('#orderMode').value;
  state.words = orderWords(parseWords($('#wordBox').value), state.order);
  state.idx=0; state.stars=0; state.stage=0;
  updateHud(); show('home');
}
$('#apply').addEventListener('click', applySettings);
$('#start').addEventListener('click', ()=>{
  applySettings();
  if(state.words.length===0){ alert('Please add some words first.'); return; }
  stage1();
});
$('#reset').addEventListener('click', ()=>{ if(timerId) clearInterval(timerId); state.idx=0; state.stars=0; state.stage=0; updateHud(); show('home'); });
$('#again').addEventListener('click', ()=>{ state.idx=0; state.stars=0; stage1(); });
$('#howTo').addEventListener('click', ()=>{
  alert('How to play:\n\n1) Tap the letters in order.\n2) Drag tiles into the boxes.\n3) Type the word before the timer ends.\n\nNow fixed for repeated letters like "banana" or "apple".');
});

// Import/Export
$('#exportBtn').addEventListener('click', ()=>{
  const data = { words: state.words, idx: state.idx, stars: state.stars, difficulty: state.difficulty, limit: state.limit, order: state.order };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='robot-words-progress.json'; a.click(); URL.revokeObjectURL(a.href);
});
$('#importBtn').addEventListener('click', ()=>$('#filePicker').click());
$('#filePicker').addEventListener('change', (e)=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const d=JSON.parse(reader.result);
      if(Array.isArray(d.words)) $('#wordBox').value=d.words.join('\n');
      if(d.limit) $('#timeLimit').value=d.limit;
      if(d.difficulty) $('#difficulty').value=d.difficulty;
      if(d.order) $('#orderMode').value=d.order;
      applySettings();
      alert('Progress imported!');
    }catch{ alert('Invalid file.'); }
  };
  reader.readAsText(file);
});

// Init
applySettings();
</script>
</body>
</html>
