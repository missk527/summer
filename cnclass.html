<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Miss K‰∏≠ÊñáÁ∑¥Â≠óÈÅäÊà≤</title>
  <style>
    :root{
      --bg1:#fff7cc; --bg2:#ffe689; --card:#fffaf0; --ink:#2b2111; --muted:#75664f; --brand:#c27c2c; --accent:#5a8f2b;
      --line:#c8a75a; --grid:#e6cf86; --diag:#dec67a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei","Hiragino Sans CNS","PMingLiU",sans-serif}
    body::before{content:""; position:fixed; inset:0; pointer-events:none; opacity:.1;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Cg fill='%23b48b2a'%3E%3Ccircle cx='25' cy='25' r='10'/%3E%3Ccircle cx='45' cy='18' r='8'/%3E%3Ccircle cx='65' cy='25' r='10'/%3E%3Ccircle cx='45' cy='38' r='9'/%3E%3Cpath d='M88 88c10 12 2 22-14 18-11-3-20-12-22-18-2-7 3-14 12-16 9-1 16 3 24 16z'/%3E%3C/g%3E%3C/svg%3E");
      background-size:120px 120px; background-repeat:repeat; }
    .wrap{max-width:1100px;margin:30px auto;padding:0 16px}
    .app{display:grid;grid-template-columns:360px 1fr;gap:18px}
    @media (max-width:980px){.app{grid-template-columns:1fr}}
    .card{background:var(--card);border:2px solid var(--line);border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .pane{padding:16px}
    h1{font-weight:800;font-size:22px;margin:0 0 10px;letter-spacing:.02em}
    h1::before{content:"üêæ ";}
    p.help{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .row label{font-size:13px;color:var(--muted)}
    .row input[type="text"], .row textarea, .row input[type="number"]{width:100%;background:#fff;border:1px solid #e3d5ad;color:var(--ink);padding:10px;border-radius:10px;outline:none}
    textarea{resize:vertical;min-height:64px}
    .btn{appearance:none;border:2px solid var(--line);background:#fff6d6;color:var(--ink);padding:9px 12px;border-radius:12px;cursor:pointer;font-weight:600;user-select:none;transition:.15s transform,.15s background}
    .btn:hover{background:#ffefbd}
    .btn:active{transform:translateY(1px)}
    .btn.brand{border-color:#cfa24f;background:#ffe29a}
    .btn.success{border-color:#7aa43f;background:#e6f7c4}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .score{font-size:14px;color:#7a6a41}
    .score b{font-size:18px;color:#3a2c16}
    .canvas-wrap{position:relative;aspect-ratio:1/1;width:min(86vw,560px);margin:14px auto 10px}
    canvas{position:absolute;left:0;top:0;width:100%;height:100%;border-radius:12px;touch-action:none}
    #grid,#preview{pointer-events:none}
    .hint{display:inline-block;background:#fff1b3;border:2px dashed var(--line);border-radius:12px;padding:10px 12px;color:#7a6a41;font-size:12px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;border:2px solid var(--line);background:#fff6d6;color:#3a2c16;cursor:pointer}
    .chip.active{border-color:#cfa24f;background:#ffe29a}
    .small{font-size:12px;color:#7a6a41}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Miss K‰∏≠ÊñáÁ∑¥Â≠óÈÅäÊà≤</h1>
    <div class="app">
      <div class="card pane" id="controls">
        <div class="row">
          <label for="wordlist"><b>È°åÂ∫´ÔºàÂñÆÂ≠óÔºâ</b></label>
          <textarea id="wordlist">Êàë‰Ω†‰ªñÊó•Êúà‰∫∫Ê∞ëÂè£</textarea>
          <div class="toolbar">
            <button class="btn brand" id="loadListBtn">ËºâÂÖ•È°åÂ∫´</button>
            <button class="btn" id="randomBtn">Èö®Ê©ü</button>
            <button class="btn" id="prevBtn">‰∏ä‰∏ÄÂÄã</button>
            <button class="btn" id="nextBtn">‰∏ã‰∏ÄÂÄã</button>
            <span class="small" id="indexInfo"></span>
          </div>
        </div>
        <div class="row grid">
          <div>
            <label>Á≠ÜÁï´Á≤óÁ¥∞</label>
            <input type="range" id="size" min="6" max="30" value="16" />
          </div>
          <div>
            <label>Á≠ÜËâ≤</label>
            <input type="color" id="color" value="#5b3a00" />
          </div>
        </div>
        <div class="row toolbar">
          <button class="btn" id="toggleGuide">È°ØÁ§∫ÂèÉËÄÉÂ≠ó</button>
          
        </div>
        <div class="row toolbar">
         
          <button class="btn brand" id="scoreBtn">Ë©ïÂàÜ</button>
          <span class="score" id="scoreBox">ÂàÜÊï∏Ôºö<b>‚Äî</b></span>
        </div>
        
        
      </div>
      <div class="card pane">
        <div class="chips" id="charChips"></div>
        <div class="canvas-wrap">
          <canvas id="grid"></canvas>
          <canvas id="draw"></canvas>
          <canvas id="preview"></canvas>
        </div>
      </div>
    </div>
  </div>
<script>
(function(){
  const dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
  const grid=document.getElementById('grid');
  const draw=document.getElementById('draw');
  const preview=document.getElementById('preview');
  const sizeSlider=document.getElementById('size');
  const colorInput=document.getElementById('color');
  const scoreBox=document.getElementById('scoreBox').querySelector('b');
  const wordlistEl=document.getElementById('wordlist');
  const chipsEl=document.getElementById('charChips');
  const indexInfo=document.getElementById('indexInfo');

  let strokes=[]; let currentStroke=null; let correctedStrokes=null;
  let words=[]; let currentIndex=0; let showGuide=false;

  const fontStack="'Noto Serif TC','PingFang TC','Microsoft JhengHei','Hiragino Sans CNS','PMingLiU',serif";

  function setupCanvases(){
    const wrap=document.querySelector('.canvas-wrap');
    const cssW=wrap.clientWidth; const cssH=wrap.clientWidth;
    [grid,draw,preview].forEach(c=>{c.width=Math.floor(cssW*dpr);c.height=Math.floor(cssH*dpr);c.style.width=cssW+'px';c.style.height=cssH+'px';const ctx=c.getContext('2d');ctx.setTransform(1,0,0,1,0,0);ctx.scale(dpr,dpr);});
    drawAll();
  }
  window.addEventListener('resize',setupCanvases);

  function drawMiZiGe(){
    const ctx=grid.getContext('2d'); const w=grid.width/dpr,h=grid.height/dpr;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle='#fffbe0'; ctx.fillRect(0,0,w,h);
    ctx.lineWidth=2; ctx.strokeStyle=varColor('--line'); ctx.strokeRect(6,6,w-12,h-12);
    ctx.strokeStyle=varColor('--grid'); ctx.beginPath(); ctx.moveTo(w/2,10); ctx.lineTo(w/2,h-10); ctx.moveTo(10,h/2); ctx.lineTo(w-10,h/2); ctx.stroke();
    ctx.strokeStyle=varColor('--diag'); ctx.beginPath(); ctx.moveTo(10,10); ctx.lineTo(w-10,h-10); ctx.moveTo(w-10,10); ctx.lineTo(10,h-10); ctx.stroke();
    if(showGuide){drawReferenceChar(ctx,getCurrentChar(),0.15);}
  }

  function drawReferenceChar(ctx,ch,a){const w=grid.width/dpr,h=grid.height/dpr;const margin=Math.min(w,h)*0.12;const box=Math.min(w,h)-margin*2;ctx.save();ctx.globalAlpha=a;ctx.fillStyle='#c27c2c';ctx.textAlign='center';ctx.textBaseline='middle';ctx.font=`${box}px ${fontStack}`;ctx.fillText(ch,w/2,h/2);ctx.restore();}

  function redrawStrokes(){const ctx=draw.getContext('2d');const w=draw.width/dpr,h=draw.height/dpr;ctx.clearRect(0,0,w,h);ctx.lineCap='round';ctx.lineJoin='round';ctx.strokeStyle=colorInput.value;ctx.lineWidth=+sizeSlider.value;for(const s of strokes){if(s.length<2)continue;ctx.beginPath();ctx.moveTo(s[0].x,s[0].y);for(let i=1;i<s.length;i++){ctx.lineTo(s[i].x,s[i].y);}ctx.stroke();}}

  function redrawPreview(){const ctx=preview.getContext('2d');const w=preview.width/dpr,h=preview.height/dpr;ctx.clearRect(0,0,w,h);if(!correctedStrokes)return;ctx.lineCap='round';ctx.lineJoin='round';ctx.strokeStyle='#cfa24f';ctx.setLineDash([6,5]);ctx.lineWidth=Math.max(8,+sizeSlider.value-2);for(const s of correctedStrokes){if(s.length<2)continue;ctx.beginPath();ctx.moveTo(s[0].x,s[0].y);for(let i=1;i<s.length;i++){ctx.lineTo(s[i].x,s[i].y);}ctx.stroke();}ctx.setLineDash([]);}

  function drawAll(){drawMiZiGe();redrawStrokes();redrawPreview();}

  // === Ë©ïÂàÜÊâÄÈúÄÊñπÊ≥ïÔºàIoUÔºâ ===
  function renderCharToCanvas(ch){
    const c=document.createElement('canvas'); c.width=512; c.height=512; const ctx=c.getContext('2d');
    ctx.fillStyle='#000'; ctx.textAlign='center'; ctx.textBaseline='middle';
    let fontSize=430; ctx.font=`${fontSize}px ${fontStack}`; ctx.clearRect(0,0,512,512);
    ctx.fillText(ch,256,264); // Âü∫Á∑öÂæÆË™ø
    return c;
  }
  function boundsFromBitmap(canvas){
    const ctx=canvas.getContext('2d'); const img=ctx.getImageData(0,0,canvas.width,canvas.height).data;
    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity; let any=false; const w=canvas.width,h=canvas.height;
    for(let y=0;y<h;y++){ for(let x=0;x<w;x++){ const a=img[(y*w+x)*4+3]; if(a>6){ any=true; if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; } } }
    if(!any) return {minX:0,minY:0,maxX:w,maxY:h,width:w,height:h};
    return {minX,minY,maxX,maxY,width:Math.max(1,maxX-minX+1),height:Math.max(1,maxY-minY+1)};
  }
  function drawUserTo(ctx,targetSize){
    if(!strokes.length) return false;
    // ÂèñÈÇäÁïå
    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity; for(const s of strokes){ for(const p of s){ if(p.x<minX)minX=p.x; if(p.y<minY)minY=p.y; if(p.x>maxX)maxX=p.x; if(p.y>maxY)maxY=p.y; } }
    const w=maxX-minX||1, h=maxY-minY||1; const pad=18; const box=targetSize-pad*2; const scale=Math.min(box/w,box/h);
    const cx=targetSize/2, cy=targetSize/2; const drawW=w*scale, drawH=h*scale; const offX=cx-(minX*scale+drawW/2); const offY=cy-(minY*scale+drawH/2);
    ctx.save(); ctx.translate(offX,offY); ctx.scale(scale,scale);
    ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#000'; const targetThickness=32; ctx.lineWidth=targetThickness/scale;
    for(const s of strokes){ if(s.length<2) continue; ctx.beginPath(); ctx.moveTo(s[0].x,s[0].y); for(let i=1;i<s.length;i++){ ctx.lineTo(s[i].x,s[i].y);} ctx.stroke(); }
    ctx.restore();
    return true;
  }
  function drawRefTo(ctx,ch,targetSize){
    const c=renderCharToCanvas(ch); const bb=boundsFromBitmap(c); const pad=18; const box=targetSize-pad*2; const scale=Math.min(box/bb.width,box/bb.height);
    const dw=bb.width*scale, dh=bb.height*scale; const ox=(targetSize-dw)/2 - bb.minX*scale; const oy=(targetSize-dh)/2 - bb.minY*scale;
    ctx.save(); ctx.translate(ox,oy); ctx.scale(scale,scale); ctx.drawImage(c,0,0); ctx.restore();
  }
  function computeIoU(userCtx,refCtx,size){
    const a=userCtx.getImageData(0,0,size,size).data; const b=refCtx.getImageData(0,0,size,size).data; let inter=0,uni=0;
    for(let i=0;i<a.length;i+=4){ const aa=a[i+3]>20, bb=b[i+3]>20; if(aa||bb) uni++; if(aa&&bb) inter++; }
    if(uni===0) return 0; return inter/uni;
  }
  function score(){
    const S=256; const u=document.createElement('canvas'); u.width=S; u.height=S; const uc=u.getContext('2d');
    const r=document.createElement('canvas'); r.width=S; r.height=S; const rc=r.getContext('2d');
    const ok=drawUserTo(uc,S); if(!ok) return null; drawRefTo(rc,getCurrentChar(),S); return Math.round(computeIoU(uc,rc,S)*100);
  }

  function getPt(e){const r=draw.getBoundingClientRect();const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;return{x,y};}

  ;(function(){let drawing=false;draw.addEventListener('pointerdown',e=>{e.preventDefault();draw.setPointerCapture(e.pointerId);drawing=true;currentStroke=[];const p=getPt(e);currentStroke.push(p);strokes.push(currentStroke);redrawStrokes();},{passive:false});draw.addEventListener('pointermove',e=>{if(!drawing)return;e.preventDefault();const p=getPt(e);currentStroke.push(p);redrawStrokes();},{passive:false});const end=e=>{if(!drawing)return;e.preventDefault();drawing=false;if(currentStroke&&currentStroke.length<2){strokes.pop();}currentStroke=null;correctedStrokes=null;redrawPreview();};draw.addEventListener('pointerup',end,{passive:false});draw.addEventListener('pointercancel',end,{passive:false});draw.addEventListener('pointerleave',end,{passive:false});})();

  function varColor(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}

  function getCurrentChar(){return words.length?words[currentIndex]:'‰∏Ä';}
  function setWordsFromInput(){const raw=(wordlistEl.value||'').replace(/\s+/g,'');const arr=Array.from(raw);words=arr.filter(ch=>/\S/.test(ch));if(!words.length)words=['‰∏Ä','‰∫∫','Â§©','Â§ß','ÂøÉ','ÊÑõ','Âãá','Â≠∏','Êõ∏','Èæç','Ê®Ç'];currentIndex=0;renderChips();setIndex(0);} 
  function renderChips(){chipsEl.innerHTML='';words.forEach((ch,i)=>{const b=document.createElement('button');b.textContent=ch;b.className='chip'+(i===currentIndex?' active':'');b.onclick=()=>setIndex(i);chipsEl.appendChild(b);});}
  function setIndex(i){currentIndex=((i%words.length)+words.length)%words.length;indexInfo.textContent=`Ôºà${currentIndex+1}/${words.length}Ôºâ`;strokes=[];correctedStrokes=null;drawAll();renderChips();scoreBox.textContent='‚Äî';}

  document.getElementById('toggleGuide').onclick=()=>{showGuide=!showGuide;drawAll();};
  document.getElementById('undoBtn').onclick=()=>{strokes.pop();drawAll();};
  document.getElementById('clearBtn').onclick=()=>{strokes=[];drawAll();};
  document.getElementById('loadListBtn').onclick=()=>setWordsFromInput();
  document.getElementById('nextBtn').onclick=()=>setIndex(currentIndex+1);
  document.getElementById('prevBtn').onclick=()=>setIndex(currentIndex-1);
  document.getElementById('randomBtn').onclick=()=>{if(!words.length)return;setIndex(Math.floor(Math.random()*words.length));};
  // ÂïüÁî®Ë©ïÂàÜÊåâÈàï
  document.getElementById('scoreBtn').onclick=()=>{ const s=score(); scoreBox.textContent = (s==null? '‚Äî' : (s+' ÂàÜ')); };

  setupCanvases();
  setWordsFromInput();
})();
</script>
</body>
</html>
